#!/bin/bash
#SBATCH -D /scratch2/nvollmer/log/array_jobs
#SBATCH --mail-type=END
#SBATCH --mail-user=nicole.vollmer@noaa.gov
#SBATCH --partition=standard
#SBATCH --cpus-per-task=4
#SBATCH --mem=60G
#SBATCH --time=05:00:00
#SBATCH --job-name=bwa
#SBATCH --output=%x.%A.%a.out
#SBATCH --error=%x.%A.%a.err
#SBATCH --array=[1-285]%25

module load bio/samtools/1.19
module load aligners/bwa-mem2/2.2.1


indir=/scratch2/nvollmer/241129_NOA015_PanTrop_WGS/
bwagenind=/scratch2/nvollmer/refseq/Stenella_attenuata_HiC.fasta.gz
outdir=/scratch2/nvollmer/analysis/alignment/241129_NOA015_PanTrop_WGS/
run=run1

fq1=$(find $indir -name "*R1_001.fastq.gz" | sed -n $(echo $SLURM_ARRAY_TASK_ID)p)
fq2=$(echo $fq1 | sed 's/R1_001.fastq.gz/R2_001.fastq.gz/g')
sample=$(echo $fq1 | cut -f 5 -d "/" | cut -f 1 -d "_")
library=$(echo $fq1 | cut -f 5 -d "/" | cut -f 3 -d "_")


rg=$(echo \@RG\\tID:$sample\\tPL:Illumina\\tPU:x\\tLB:${library}_${run}\\tSM:$sample)
tempsort=$sample.$library.$run.temp
outfile=$outdir/$sample_$library.bam

echo $SLURM_ARRAY_TASK_ID
echo $sample
echo $fq1
echo $fq2
echo $rg
echo $tempsort
echo $outfile
echo $outdir

##bwa-mem2 mem -t 4 -R $rg $bwagenind $fq1 $fq2 | \
##samtools view -S -h -u - | \
##samtools sort - -O BAM -o $outfile